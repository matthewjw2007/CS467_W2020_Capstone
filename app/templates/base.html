<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% if title %}
        <title>The Neighborhood Cookbook: {{ title }}</title>
    {% else %}
        <title>Welcome to the Neighborhood Cookbook</title>
    {% endif %}
    <!--Bootstrap CDN-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!--Google Fonts-->
    <link href="https://fonts.googleapis.com/css?family=Kaushan+Script&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Fondamento&display=swap" rel="stylesheet">
    <!--Font Awesome-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- jQuery CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
    <button type="button" class="btn btn-secondary" id="dark-mode-btn">Dark Mode</button>
    <div class="outer-container" id="main-container">
        <!--Jumbotron start-->
        <div class="jumbotron">
            <div id="carouselExampleControls" class="carousel slide carousel-fade" data-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active" data-interval="6000">
                        <img src="../../../../static/imgs/michaela-baum-VnM6_liIRJ0-unsplash.jpg" class="d-block w-100 carousel-image" alt="...">
                        <div class="carousel-caption">
                            <h1 class="carousel-words">The Neighborhood Cookbook</h1>
                            <hr class="carousel-hr">
                        </div>
                    </div>
                    <div class="carousel-item" data-interval="6000">
                        <img src="../../../../static/imgs/gabriele-bartoletti-stella-hhlF006622M-unsplash.jpg" class="d-block w-100 carousel-image" alt="...">
                        <div class="carousel-caption">
                            <h1 class="carousel-words">The Neighborhood Cookbook</h1>
                            <hr class="carousel-hr">
                        </div>
                    </div>
                    <div class="carousel-item" data-interval="6000">
                        <img src="../../../../static/imgs/zahrin-lukman-FYc-qfATAk4-unsplash.jpg" class="d-block w-100 carousel-image" alt="...">
                        <div class="carousel-caption">
                            <h1 class="carousel-words">The Neighborhood Cookbook</h1>
                            <hr class="carousel-hr">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--Jumbotron end-->
        <!--Navbar start-->
        <nav class="navbar navbar-expand-md navbar-light" id="main-navbar">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.index') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('pantry.view_pantry') }}">My Pantry</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('users.get_recipes') }}">My Recipes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('recipes.find_recipes') }}">Find Recipes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('users.user') }}">My Account</a>
                    </li>
                </ul>
                {% if current_user.is_anonymous %}
                {% else %}
                <span id="my-tasks-span" class="navbar-text">
                    <div id="my-tasks">My Tasks
                        <ul id="dropdown">
                            <li id='default-li-1'></li>
                            <li id='default-li-2'></li>
                            <li id='default-li-3'></li>
                            <li id='default-li-4'></li>
                            <li id='default-li-5'></li>
                        </ul>
                    </div>
                </span>
                {% endif %}
                <span class="navbar-text">
                    {% if current_user.is_anonymous %}
                    <a class="nav-link" href="{{ url_for('users.register') }}">Register</a>
                    {% else %}
                    <a class="nav-link" href="{{ url_for('users.logout') }}">Log Out<i class="fas fa-user-minus"></i></a>
                    {% endif %}
                </span>
            </div>
        </nav>
        <!--Navbar end-->

        <!--Block content-->
        {% block content %}{% endblock %}

    </div>

    <!--Footer-->
    <footer id="sticky-footer" class="py-4 bg-dark text-white-50">
        <div class="container text-center">
            <small>Copyright &copy; 2020: The Neighborhood Cookbook</small>
        </div>
    </footer>

    <!--JS file-->
    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <!--Bootstrap JQuery-->
    <!--script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"></script-->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/b74989739b.js" crossorigin="anonymous"></script>
    {% if current_user.is_anonymous %}
    {% else %}
    <script>
        $(function() {
            // Get number of searches active
            $.ajax({
                type: 'GET',
                url: "{{url_for('recipes.num_jobs', user_id=current_user.id)}}",
                success: function(data, status, request) {
                    console.log(data);
                    if (data['num_jobs'] == '0') {
                        $('#default-li-5').text("You don't have any searches active at this time.");
                    }
                    else {
                        updateTasks();
                    }
                }
            });
        })
        function updateTasks() {
            $.ajax({
                type: 'GET',
                url: "{{url_for('recipes.users_searches', user_id=current_user.id)}}",
                success: function(data, status, request) {
                    console.log(data);
                    var taskArr = data['tasks'];
                    $('.tasked').removeClass("tasked");
                    if (taskArr.length == 0) {
                        $('#default-li-5').text("You don't have any searches active at this time.");
                    } 
                    else {
                        for (let i = 0; i < taskArr.length; i++) {
                            console.log('Task_id is: ' + taskArr[i]['task_id']);
                            var task_id = taskArr[i]['task_id'];
                            if (i == (taskArr.length - 1)) {
                                if (taskArr[i]['status'] == 'finished') {
                                    $('#default-li-5').html("<a href='/recipes/search/{{current_user.id}}/current_searches/" + task_id + "'>" + taskArr[i]['search_string'] + "\nStatus: " + taskArr[i]['status'] + "</a>");
                                }
                                else {
                                    $('#default-li-5').text(taskArr[i]['search_string'] + "\nStatus: " + taskArr[i]['status']);
                                }
                            }
                            else {
                                if (taskArr[i]['status'] == 'finished') {
                                    $('#default-li-' + (i + 1)).html("<a href='/recipes/search/{{current_user.id}}/current_searches/" + task_id + "'>" + taskArr[i]['search_string'] + "\nStatus: " + taskArr[i]['status'] + "</a>");
                                }
                                else {
                                    $('#default-li-' + (i + 1)).text(taskArr[i]['search_string'] + "\nStatus: " + taskArr[i]['status']);
                                }
                                $('#default-li-' + (i + 1)).addClass("tasked");
                            }
                        }
                        setTimeout(function() {
                            console.log("Checking status again...");
                            updateTasks();
                        }, 2000);
                    }
                }
            })
        }
    </script>
    {% endif %}
</body>
</html>